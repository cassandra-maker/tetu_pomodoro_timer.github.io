<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Focus Flow</title>
    <link rel="manifest" href="manifest.json">
    <style>
        :root {
            --bg: #e0e5ec;
            --sh-1: #ffffff;
            --sh-2: #a3b1c6;
            --accent: #4a90e2;
        }
        body {
            background-color: var(--bg);
            font-family: 'Segoe UI', sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            overflow: hidden;
        }
        .glass-card {
            background: var(--bg);
            padding: 40px;
            border-radius: 50px;
            box-shadow: 20px 20px 60px var(--sh-2), -20px -20px 60px var(--sh-1);
            text-align: center;
            width: 300px;
        }
        #status { font-size: 1.2rem; color: #777; margin-bottom: 20px; font-weight: bold; }
        
        .timer-container {
            position: relative;
            width: 200px;
            height: 200px;
            margin: 0 auto 30px;
        }
        svg { transform: rotate(-90deg); }
        .circle-bg { fill: none; stroke: var(--bg); stroke-width: 10; }
        .circle-progress {
            fill: none; stroke: var(--accent); stroke-width: 10;
            stroke-linecap: round; stroke-dasharray: 565.48;
            stroke-dashoffset: 0; transition: stroke-dashoffset 1s linear;
        }
        #timer {
            position: absolute; top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            font-size: 3rem; font-weight: bold; color: #444;
            font-variant-numeric: tabular-nums;
        }

        .btn {
            border: none; padding: 15px 30px; border-radius: 15px;
            background: var(--bg); font-weight: bold; cursor: pointer;
            box-shadow: 6px 6px 12px var(--sh-2), -6px -6px 12px var(--sh-1);
            transition: all 0.2s; margin: 5px; color: #555;
            outline: none;
        }
        .btn:active { box-shadow: inset 4px 4px 8px var(--sh-2), inset -4px -4px 8px var(--sh-1); }
        .btn-primary { color: var(--accent); }
    </style>
</head>
<body>

<div class="glass-card">
    <div id="status">集中タイム (25分)</div>
    <div class="timer-container">
        <svg width="200" height="200">
            <circle class="circle-bg" cx="100" cy="100" r="90"></circle>
            <circle id="progress" class="circle-progress" cx="100" cy="100" r="90"></circle>
        </svg>
        <div id="timer">25:00</div>
    </div>
    <button id="startBtn" class="btn btn-primary">START</button>
    <button id="resetBtn" class="btn">RESET</button>
</div>

<script>
// --- 仏教風サウンド生成ロジック ---
let breakSoundSource = []; // 複数のオシレーターを管理

function playBuddhistBowl() {
    if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    if (audioCtx.state === 'suspended') audioCtx.resume();

    const now = audioCtx.currentTime;
    
    // おりんの音を構成する周波数（基音と倍音）
    // 少しずらすことで「うなり」を生み出します
    const freqs = [110, 220.5, 440.2, 880.4, 1200]; 
    
    freqs.forEach((f, i) => {
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        
        osc.type = 'sine'; // 澄んだ音にするためにサイン波を使用
        osc.frequency.setValueAtTime(f, now);
        
        // 音の強弱（エンベロープ）の設定
        // 最初は強く、その後非常にゆっくり消えていく
        gain.gain.setValueAtTime(i === 0 ? 0.2 : 0.1, now); 
        gain.gain.exponentialRampToValueAtTime(0.0001, now + 10); // 10秒かけて消える
        
        osc.connect(gain);
        gain.connect(audioCtx.destination);
        
        osc.start(now);
        osc.stop(now + 10);
    });
}

// 休憩中のバックグラウンド・ドローン音（低く響く音）
function startBreakDrone() {
    stopNoise(); // 既存の音を停止
    if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    
    const baseFreq = 110; // 低いAの音
    [1, 1.01].forEach(detune => { // 微妙にずらして「ゆらぎ」を作る
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.frequency.value = baseFreq * detune;
        gain.gain.value = 0.02; // 非常に小さな音で鳴らす
        osc.connect(gain);
        gain.connect(audioCtx.destination);
        osc.start();
        breakSoundSource.push(osc);
    });
}

function stopBreakSound() {
    breakSoundSource.forEach(osc => osc.stop());
    breakSoundSource = [];
}

// --- モード切替ロジックの修正 ---
function switchMode() {
    if (isWorking) {
        // 集中終了 -> 休憩へ
        navigator.vibrate(VIBRATE_WORK_END);
        stopNoise(); 
        playBuddhistBowl(); // ★おりんを鳴らす
        startBreakDrone();  // ★瞑想音を開始
        isWorking = false;
        timeLeft = 5 * 60;
        document.getElementById('status').textContent = "休憩・瞑想タイム (5分)";
        document.getElementById('status').style.color = "#d4af37"; // 仏教っぽいゴールド
    } else {
        // 休憩終了 -> 集中へ
        navigator.vibrate(VIBRATE_REST_END);
        stopBreakSound(); // ★休憩の音を止める
        isWorking = true;
        timeLeft = 25 * 60;
        document.getElementById('status').textContent = "集中タイム (25分)";
        document.getElementById('status').style.color = "var(--accent)";
        startNoise(); 
    }
    totalTime = timeLeft;
    updateDisplay();
}
</script>
</body>

</html>
